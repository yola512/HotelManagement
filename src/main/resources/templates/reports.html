<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hotel Admin - Reports</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <!-- chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!--Navigation bar -->
<nav class="navbar navbar-expand-lg navbar-dark navbar-transparent fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#">Hotel Admin</a>
        <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="/home">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="/meals">Meals</a></li>
            <li class="nav-item"><a class="nav-link" href="/rooms">Rooms</a></li>
            <li class="nav-item"><a class="nav-link" href="/bookings">Bookings</a></li>
            <li class="nav-item"><a class="nav-link" href="/reviews">Reviews</a></li>
            <li class="nav-item"><a class="nav-link active" href="/reports">Reports</a></li>
        </ul>
    </div>
</nav>
<!-- navbar stops being transparent after scroll -->
<script src="/js/navbar.js"></script>

<!-- background image -->
<div class="background-section bg-reports">
    <!-- gradient overlay-->
    <div class="hero-overlay"></div>
</div>

<!-- reports Section -->
<div class="container mt-4">
    <h1 class="mb-4">Reports & Statistics</h1>

    <div class="card mb-4">
        <div class="card-header text-white table-style">Employees by Job Title</div>
        <div class="card-body">
            <canvas id="jobTitleChart"></canvas>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header text-white table-style">Room Popularity</div>
        <div class="card-body">
            <canvas id="roomPopularityChart"></canvas>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header text-white table-style">Monthly Booking Volume</div>
        <div class="card-body">
            <canvas id="bookingsOverTimeChart"></canvas>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header text-white table-style">Employees Reports</div>
        <div class="card-body">
            <form id="employeeForm">
                <div class="row mb-2">
                    <div class="col-md-6">
                        <label for="salaryGt" class="form-label">Salary Greater Than:</label>
                        <input type="number" step="0.01" id="salaryGt" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="salaryLt" class="form-label">Salary Less Than:</label>
                        <input type="number" step="0.01" id="salaryLt" class="form-control">
                    </div>
                </div>
                <button type="button" class="btn btn-secondary me-2" onclick="fetchEmployeesBySalary(true)">Salary ></button>
                <button type="button" class="btn btn-secondary" onclick="fetchEmployeesBySalary(false)">Salary <</button>
            </form>
            <div id="employeeResults" class="mt-3"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        fetchJobTitleChart();
        fetchPopularRoomsChart();
        fetchBookingsOverTimeChart();
    });

    function generateColors(count) {
        const colors = [
            '#a0b37f', '#d9b37f', '#72c8c8', '#4f7f80', '#6c757d',
            '#808000', '#5a4a3c', '#6c4c4c', '#cca844', '#20c997'
        ];
        return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
    }

    function displayResults(data, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
    }

    // functions related to charts (used chart.js)
    // pie chart - employees by job title
    async function fetchJobTitleChart() {
        const response = await fetch('api/reports/job-titles');
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();

        // calculations and preparing data
        const labels = data.map(item => item.jobTitle);
        const counts = data.map(item => item.count);
        const total = counts.reduce((sum, count) => sum + count, 0);
        const percentages = counts.map(count => ((count/total) * 100).toFixed(1));

        // chart drawing
        new Chart(document.getElementById('jobTitleChart'), {
            type: 'pie',
            data: {
                labels: labels.map((label, i) => `${label} (${percentages[i]}%)`),
                datasets: [{
                    data: counts,
                    backgroundColor: generateColors(labels.length),
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {position: 'right'},
                    title: {display: true, text: 'Percentage of employees by job title'}
                }
            }
        });
    }

    // most popular rooms (bar chart)
    async function fetchPopularRoomsChart() {
        const response = await fetch('/api/reports/popular-rooms');
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        //we use only top 15 to make sure the chart is easy to read
        const topData = data.slice(0,15);
        const labels = topData.map(item => `NR: ${item.roomId} (${item.roomType.replace(/_/g, ' ')})`);
        const counts = topData.map(item => item.count);

        new Chart(document.getElementById("roomPopularityChart"), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of bookings',
                    data: counts,
                    backgroundColor: generateColors(labels.length),
                    borderColor: '#333',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {display: false},
                    title: {
                        display: true,
                        text: 'Top 15 most frequently booked rooms (NR and Type)'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        autoSkip: false,
                        minRotation: 45,
                        maxRotation: 45
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: "Number of bookings"
                    }
                }
            }
        })

    }

    // monthly booking count (line chart)
    async function fetchBookingsOverTimeChart() {
        const response = await fetch("api/reports/bookings-monthly")
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        // sorting by date (monthYear)
        data.sort((a,b) => new Date(a.monthYear) - new Date(b.monthYear));

        const labels = data.map(item => item.monthYear);
        const counts = data.map(item => item.count);

        new Chart(document.getElementById('bookingsOverTimeChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Bookings',
                    data: counts,
                    fill: true,
                    borderColor: '#c8ab72',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Monthly Booking Volume' }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Bookings'
                        }
                    }
                }
            }
        });
    }

    // functions related to reports
    async function fetchEmployeesBySalary(isGreater) {
        const val = isGreater
            ? document.getElementById("salaryGt").value
            : document.getElementById("salaryLt").value;

        if (!val || isNaN(parseFloat(val))) {
            // if there field is empty or invalid; display cleaned results again
            displayResults([], "employeeResults");
            return;
        }

        const x = isGreater ? "greater-than" : "less-than";
        const url = `/api/reports/employees/salary/${x}/${val}`;

        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        displayResults(data, "employeeResults");
    }

</script>

</body>
</html>