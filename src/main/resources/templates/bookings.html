<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hotel Admin - Bookings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

<!-- Navigation bar -->
<nav class="navbar navbar-expand-lg navbar-dark navbar-transparent fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#">Hotel Admin</a>
        <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="/home">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="/meals">Meals</a></li>
            <li class="nav-item"><a class="nav-link" href="/rooms">Rooms</a></li>
            <li class="nav-item"><a class="nav-link active" href="/bookings">Bookings</a></li>
            <li class="nav-item"><a class="nav-link" href="/reviews">Reviews</a></li>
            <li class="nav-item"><a class="nav-link" href="/reports">Reports</a></li>
        </ul>
    </div>
</nav>
<!-- navbar stops being transparent after scroll -->
<script src="/js/navbar.js"></script>

<!-- background image -->
<div class="background-section bg-bookings">
    <!-- gradient overlay-->
    <div class="hero-overlay"></div>
</div>

<!-- Page content -->
<div class="container mt-4">
    <h1 class="mb-4">Booking Management</h1>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header table-style text-white">Filter Bookings</div>
        <div class="card-body">
            <form id="filterForm">
                <div class="row mb-2">
                    <div class="col-md-4">
                        <!--client name, surname-->
                        <label for="clientFilter" class="form-label">Client</label>
                        <input type="text" id="clientFilter" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label for="checkInFilter" class="form-label">Check in date:</label>
                        <input type="date" id="checkInFilter" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label for="checkOutFilter" class="form-label">Check out date</label>
                        <input type="date" id="checkOutFilter" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label for="mealPlanFilter" class="form-label">Meal plan:</label>
                        <select id="mealPlanFilter" class="form-select">
                            <option value="">All</option>
                            <option value="BED_AND_BREAKFAST">B&B</option>
                            <option value="HALF_BOARD">Half Board</option>
                            <option value="FULL_BOARD">Full Board</option>
                            <option value="ALL_INCLUSIVE">All Inclusive</option>
                            <option value="ROOM_ONLY">Room only</option>
                            <option value="SELF_CATERING">Self catering</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="roomFilter" class="form-label">Room:</label>
                        <input type="number" id="roomFilter" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Status:</label>
                        <select id="statusFilter" class="form-select">
                            <option value="">All</option>
                            <option value="PENDING">Pending</option>
                            <option value="CONFIRMED">Confirmed</option>
                            <option value="CANCELLED">Cancelled</option>
                            <option value="CHECKED_IN">Checked-in</option>
                            <option value="CHECKED_OUT">Checked-out</option>
                        </select>
                    </div>
                    <!-- Reset filters -->
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-secondary w-100 mt-3" onclick="resetFilters()">Reset Filters</button>
                    </div>
                </div>
            </form>
            <div id="bookingResults" class="mt-3"></div>
        </div>
    </div>

    <!-- Reservation list -->
    <div class="card">
        <div class="card-header table-style text-white d-flex justify-content-between align-items-center">
            Bookings
            <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#bookingModal"
                    onclick="showAddBookingModal()">Add Booking
            </button>
        </div>
        <div class="card-body">
            <table class="table table-bordered table-striped">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Client ID</th>
                    <th>Client</th> <!-- name, surname -->
                    <th>Room(s)</th> <!-- room(s) id-->
                    <th>Meals</th> <!-- meal plan-->
                    <th>Booking date</th>
                    <th>Check in</th>
                    <th>Check out</th>
                    <th>Total price</th>
                    <th>Status</th>
                    <th>Employee ID</th>
                    <th>Employee</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="bookingTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Editing/adding booking -->
<!-- adding booking should be allowed cause some clients prefer to book in person, not online-->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">Add Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <input type="hidden" id="bookingId">

                    <!-- CLIENT SECTION -->
                    <div class="card mb-3">
                        <div class="card-header">Client Information</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Select existing client or add new</label>
                                <div class="btn-group w-100 mb-2" role="group">
                                    <input type="radio" class="btn-check" name="clientOption" id="existingClient" checked>
                                    <label class="btn btn-outline-primary" for="existingClient">Existing Client</label>

                                    <input type="radio" class="btn-check" name="clientOption" id="newClient">
                                    <label class="btn btn-outline-primary" for="newClient">New Client</label>
                                </div>
                            </div>

                            <!-- Existing client dropdown -->
                            <div id="existingClientSection">
                                <select class="form-select" id="clientId">
                                    <option value=""></option>
                                </select>
                            </div>

                            <!-- New client form -->
                            <div id="newClientSection" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label for="newClientName" class="form-label">Name</label>
                                        <input type="text" class="form-control" id="newClientName">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label for="newClientSurname" class="form-label">Surname</label>
                                        <input type="text" class="form-control" id="newClientSurname">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label for="newClientEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="newClientEmail">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label for="newClientPhone" class="form-label">Phone</label>
                                        <input type="tel" class="form-control" id="newClientPhone">
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label for="newClientBirthDate" class="form-label">Birth Date</label>
                                    <input type="date" class="form-control" id="newClientBirthDate">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ROOMS SECTION -->
                    <div class="mb-3">
                        <label for="roomIds" class="form-label">Rooms - hold CTRL (CMD on Mac) to select multiple rooms</label>
                        <select class="form-select" id="roomIds" multiple required>
                            <option value=""></option>
                        </select>
                    </div>

                    <!-- MEAL SECTION -->
                    <div class="mb-3">
                        <label for="mealId" class="form-label">Meal Plan</label>
                        <select class="form-select" id="mealId" required>
                            <option value=""></option>
                        </select>
                    </div>

                    <!-- CHECK-IN/CHECK-OUT DATE SECTION -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="checkInDate" class="form-label">Check-in Date</label>
                            <input type="date" class="form-control" id="checkInDate" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="checkOutDate" class="form-label">Check-out Date</label>
                            <input type="date" class="form-control" id="checkOutDate" required>
                        </div>
                    </div>

                    <!--BOOKING STATUS SECTION -->
                    <div class="mb-3">
                        <label for="bookingStatus" class="form-label">Status</label>
                        <select class="form-select" id="bookingStatus" required>
                            <option value="PENDING">Pending</option>
                            <option value="CONFIRMED">Confirmed</option>
                            <option value="CANCELLED">Cancelled</option>
                            <option value="CHECKED_IN">Checked-in</option>
                            <option value="CHECKED_OUT">Checked-out</option>
                        </select>
                    </div>

                    <!-- ASSIGNED EMPLOYEE SECTION -->
                    <div class="mb-3">
                        <label for="employeeId" class="form-label">Assigned Employee</label>
                        <select class="form-select" id="employeeId" required>
                            <option value=""></option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveBooking()">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>

    const API_URL = "/api/bookings";
    let bookingModal;

    document.addEventListener('DOMContentLoaded', async () => {
        bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));

        // toggle between existing/new client
        document.getElementById('existingClient').addEventListener('change', () => {
            document.getElementById('existingClientSection').style.display = 'block';
            document.getElementById('newClientSection').style.display = 'none';
        });

        document.getElementById('newClient').addEventListener('change', () => {
            document.getElementById('existingClientSection').style.display = 'none';
            document.getElementById('newClientSection').style.display = 'block';
        });

        await loadReferenceData();
        await loadBookings();
    });

    async function loadReferenceData() {
        await Promise.all([
            loadClients(),
            loadRooms(),
            loadMeals(),
            loadEmployees()
        ]);
    }

    async function loadClients() {
        try {
            const response = await fetch('/api/clients');
            const clients = await response.json();
            const select = document.getElementById('clientId');
            select.innerHTML = '<option value="">-- Select Client --</option>';
            clients.forEach(client => {
                select.innerHTML += `<option value="${client.id}">${client.name} ${client.surname} (${client.email})</option>`;
            });
        } catch (error) {
            console.error('Error loading clients:', error);
        }
    }

    async function loadRooms() {
        try {
            const response = await fetch('/api/rooms');
            const rooms = await response.json();
            const select = document.getElementById('roomIds');
            select.innerHTML = '';

            // group by room type
            const grouped = rooms.reduce((acc, room) => {
                if (!acc[room.roomType]) acc[room.roomType] = [];
                acc[room.roomType].push(room);
                return acc;
            }, {});

            // display grouped rooms
            Object.keys(grouped).forEach(type => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = type.replace(/_/g, ' ');

                grouped[type].forEach(room => {
                    const available = room.available ? '✓' : '✗';
                    const option = document.createElement('option');
                    option.value = room.id;
                    option.textContent = `${available} Room nr.${room.id} - ${room.pricePerNight} PLN/night`;
                    if (!room.available) option.disabled = true;
                    optgroup.appendChild(option);
                });

                select.appendChild(optgroup);
            });
        } catch (error) {
            console.error('Error loading rooms:', error);
        }
    }

    async function loadMeals() {
        try {
            const response = await fetch('/api/meals');
            const meals = await response.json();
            const select = document.getElementById('mealId');
            select.innerHTML = '<option value="">-- Select Meal Plan --</option>';

            meals.forEach(meal => {
                const total = meal.breakfastPrice + meal.lunchPrice + meal.dinnerPrice;
                select.innerHTML += `<option value="${meal.id}">${meal.mealPlanName.replace(/_/g, ' ')} - ${total.toFixed(2)} PLN/day</option>`;
            });
        } catch (error) {
            console.error('Error loading meals:', error);
        }
    }

    async function loadEmployees() {
        try {
            const response = await fetch('/api/employees');
            const employees = await response.json();
            const select = document.getElementById('employeeId');
            select.innerHTML = '<option value="">-- Select Employee --</option>';

            // prioritize receptionists and front office
            const frontOffice = employees.filter(e =>
                e.jobTitle === 'RECEPTIONIST' || e.jobTitle === 'FRONT_OFFICE'
            );
            const others = employees.filter(e =>
                e.jobTitle !== 'RECEPTIONIST' && e.jobTitle !== 'FRONT_OFFICE'
            );

            if (frontOffice.length > 0) {
                const group1 = document.createElement('optgroup');
                group1.label = 'Front Office Staff';
                frontOffice.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.name} ${emp.surname} - ${emp.jobTitle.replace(/_/g, ' ')}`;
                    group1.appendChild(option);
                });
                select.appendChild(group1);
            }

            if (others.length > 0) {
                const group2 = document.createElement('optgroup');
                group2.label = 'Other Staff';
                others.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.name} ${emp.surname} - ${emp.jobTitle.replace(/_/g, ' ')}`;
                    group2.appendChild(option);
                });
                select.appendChild(group2);
            }
        } catch (error) {
            console.error('Error loading employees:', error);
        }
    }

    async function loadBookings() {
        try {
            const response = await fetch(API_URL);
            const bookings = await response.json();
            displayBookings(bookings);
        } catch (error) {
            console.error('Error loading bookings:', error);
        }
    }

    function displayBookings(bookings) {
        const tbody = document.getElementById("bookingTableBody");
        tbody.innerHTML = "";

        bookings.forEach(booking => {
            // format dates
            const formatDate = (dateStr) => {
                    if (!dateStr) return "";
                    const d = new Date(dateStr);
                    return d.toLocaleDateString("pl-PL") // DD/MM/YYYY format
            }

            const clientId = booking.client?.id || "";
            const clientName = booking.client ? `${booking.client.name} ${booking.client.surname}` : "No client";

            let roomIds = "No rooms";
            if (booking.rooms && Array.isArray(booking.rooms) && booking.rooms.length > 0) {
                roomIds = booking.rooms.map(r => r.id).join(", ");
            }

            const mealPlan = booking.meal?.mealPlanName || "No meal";
            const employeeId = booking.employee?.id || "";
            const employeeName = booking.employee ? `${booking.employee.name} ${booking.employee.surname}` : "No employee";
            const totalPrice = booking.totalPrice ? `${booking.totalPrice.toFixed(2)} PLN` : "";

            tbody.innerHTML += `
            <tr>
                <td>${booking.id}</td>
                <td>${clientId}</td>
                <td>${clientName}</td>
                <td>${roomIds}</td>
                <td>${mealPlan}</td>
                <td>${formatDate(booking.bookingDate)}</td>
                <td>${formatDate(booking.checkInDate)}</td>
                <td>${formatDate(booking.checkOutDate)}</td>
                <td>${totalPrice}</td>
                <td>${booking.bookingStatus}</td>
                <td>${employeeId}</td>
                <td>${employeeName}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editBooking(${booking.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteBooking(${booking.id})">Delete</button>
                </td>
            </tr>
        `;
        });
    }

    async function saveBooking() {
        const id = document.getElementById("bookingId").value;
        const isNewClient = document.getElementById('newClient').checked;

        let clientId;

        // create new client if needed
        if (isNewClient) {
            const newClient = {
                name: document.getElementById('newClientName').value,
                surname: document.getElementById('newClientSurname').value,
                email: document.getElementById('newClientEmail').value,
                phoneNumber: document.getElementById('newClientPhone').value,
                birthDate: document.getElementById('newClientBirthDate').value
            };

            if (!newClient.name || !newClient.surname || !newClient.email || !newClient.phoneNumber) {
                alert('Please fill all required client fields');
                return;
            }

            try {
                const response = await fetch('/api/clients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newClient)
                });

                if (!response.ok) {
                    alert('Error creating new client');
                    return;
                }

                const createdClient = await response.json();
                clientId = createdClient.id;
            } catch (error) {
                alert('Error creating client: ' + error.message);
                return;
            }
        } else {
            clientId = parseInt(document.getElementById("clientId").value);
            if (!clientId) {
                alert('Please select a client');
                return;
            }
        }

        const selectedRoomIds = Array.from(document.getElementById("roomIds").selectedOptions)
            .map(opt => parseInt(opt.value));

        if (selectedRoomIds.length === 0) {
            alert('Please select at least one room');
            return;
        }

        const booking = {
            // sets id only in the nested objecct
            "client": { "id": clientId },
            "meal": { "id": parseInt(document.getElementById("mealId").value) },
            "employee": { "id": parseInt(document.getElementById("employeeId").value) },
            "rooms": selectedRoomIds.map(roomId => ({ "id": roomId })),
            "checkInDate": document.getElementById("checkInDate").value,
            "checkOutDate": document.getElementById("checkOutDate").value,
            "bookingStatus": document.getElementById("bookingStatus").value,
        };

        const method = id ? "PUT" : "POST";
        const url = id ? `${API_URL}/${id}` : API_URL;

        try {
            const response = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(booking)
            });

            if (response.ok) {
                bookingModal.hide();
                await loadBookings(); // refresh bookings' table
                await loadClients(); // refresh client list
                resetForm();
            } else {
                const error = await response.text();
                alert("Error saving booking: " + error);
            }
        } catch (error) {
            alert("Error: " + error.message);
        }
    }

    async function editBooking(id) {
        try {
            const response = await fetch(`${API_URL}/${id}`);
            const booking = await response.json();

            document.getElementById("bookingId").value = booking.id;

            // select existing client
            document.getElementById('existingClient').checked = true;
            document.getElementById('existingClientSection').style.display = 'block';
            document.getElementById('newClientSection').style.display = 'none';

            document.getElementById("clientId").value = booking.client.id;
            document.getElementById("mealId").value = booking.meal.id;
            document.getElementById("checkInDate").value = booking.checkInDate;
            document.getElementById("checkOutDate").value = booking.checkOutDate;
            document.getElementById("bookingStatus").value = booking.bookingStatus;
            document.getElementById("employeeId").value = booking.employee.id;

            // select rooms
            const roomSelect = document.getElementById("roomIds");
            Array.from(roomSelect.options).forEach(option => {
                option.selected = booking.rooms.some(r => r.id == option.value);
            });

            document.getElementById("bookingModalLabel").textContent = "Edit Booking";
            bookingModal.show();
        } catch (error) {
            alert("Error loading booking: " + error.message);
        }
    }

    async function deleteBooking(id) {
        if (!confirm("Are you sure you want to delete this booking?")) return;

        try {
            const response = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
            if (response.ok) {
                await loadBookings();
            } else {
                alert("Error deleting booking");
            }
        } catch (error) {
            alert("Error: " + error.message);
        }
    }

    function showAddBookingForm() {
        resetForm();
        document.getElementById("bookingModalLabel").textContent = "Add Booking";
        bookingModal.show();
    }

    // FILTERS
    // filter by client
    document.getElementById("clientFilter").addEventListener("input", async (e) => {
        const clientName = e.target.value.trim();
        if (!clientName) return loadBookings();
        const response = await fetch(`${API_URL}/client/${encodeURIComponent(clientName)}`);
        const bookings = await response.json();
        displayBookings(bookings);
    });
    // filter by status
    document.getElementById("statusFilter").addEventListener("change", async (e) => {
        const status = e.target.value;
        if (!status) return loadBookings();
        const response = await fetch(`${API_URL}/status/${status}`);
        const bookings = await response.json();
        displayBookings(bookings);
    });
    // filter by mealPlan
    document.getElementById("mealPlanFilter").addEventListener("change", async (e) => {
        const plan = e.target.value;
        if (!plan) return loadBookings();
        const response = await fetch(`${API_URL}/plan/${plan}`);
        const bookings = await response.json();
        displayBookings(bookings);
    });
    // filter by room
    document.getElementById("roomFilter").addEventListener("input", async (e) => {
        const room = e.target.value;
        if (!room) return loadBookings();
        if (isNaN(parseInt(room))) {
            // ignore if the input is not a number (can't be parsed to a number)
            return;
        }
        const response = await fetch(`${API_URL}/room/${room}`);
        const bookings = await response.json();
        displayBookings(bookings);
    });
    // filter by checkIn date
    document.getElementById("checkInFilter").addEventListener("input", async (e) => {
        const date = e.target.value;
        if (!date) return loadBookings();
        const response = await fetch(`${API_URL}/checkin/${date}`);
        const bookings = await response.json();
        displayBookings(bookings);
    });
    // filter by checkOut date
    document.getElementById("checkOutFilter").addEventListener("input", async (e) => {
        const date = e.target.value;
        if (!date) return loadBookings();
        const response = await fetch(`${API_URL}/checkout/${date}`);
        const bookings = await response.json();
        displayBookings(bookings);
    });

    function resetFilters() {
        document.getElementById("clientFilter").value = "";
        document.getElementById("checkInFilter").value = "";
        document.getElementById("checkOutFilter").value = "";
        document.getElementById("roomFilter").value = "";
        document.getElementById("statusFilter").value = "";
        document.getElementById("mealPlanFilter").value = "";
        loadBookings();
    }

    function resetForm() {
        document.getElementById("bookingForm").reset();
        document.getElementById("bookingId").value = "";
        document.getElementById('existingClient').checked = true;
        document.getElementById('existingClientSection').style.display = 'block';
        document.getElementById('newClientSection').style.display = 'none';
    }
    // Initial load
    loadBookings();
</script>
</body>
</html>

