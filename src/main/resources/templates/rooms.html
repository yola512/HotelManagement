<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hotel Admin - Rooms</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark navbar-transparent fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#">Hotel Admin</a>
        <ul class="navbar-nav ms-auto d-flex flex-row">
            <!-- nav-link active -> "rooms" is in bold -->
            <li class="nav-item"><a class="nav-link" href="/home">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="/meals">Meals</a></li>
            <li class="nav-item"><a class="nav-link active" href="/rooms">Rooms</a></li>
            <li class="nav-item"><a class="nav-link" href="/bookings">Bookings</a></li>
            <li class="nav-item"><a class="nav-link" href="/reviews">Reviews</a></li>
            <li class="nav-item"><a class="nav-link" href="/reports">Reports</a></li>
        </ul>
    </div>
</nav>
<!-- navbar stops being transparent after scroll -->
<script src="/js/navbar.js"></script>

<!-- background image -->
<div class="background-section bg-rooms">
    <!-- gradient overlay-->
    <div class="hero-overlay"></div>
</div>

<!-- Page Content -->
<div class="container mt-4">
    <h1 class="mb-4">Rooms Management</h1>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">Filter Rooms</div>
        <div class="card-body row">

            <!-- Filter by Room Type -->
            <div class="col-md-4 row-md-1">
                <label for="roomTypeFilter" class="form-label" >Room Type</label>
                <select id="roomTypeFilter" class="form-select mb-3">
                    <option value="">All Types</option> <!-- default -->
                    <option value="SINGLE">Single</option>
                    <option value="DOUBLE">Double</option>
                    <option value="JUNIOR_SUITE">Junior Suite</option>
                    <option value="MEDIUM_SUITE">Medium Suite</option>
                    <option value="LARGE_SUITE">Large Suite</option>
                    <option value="PRESIDENTIAL_SUITE">Presidential Suite</option>
                </select>

            <!-- Filter by Price asc/desc -->
                <label for="priceOrder" class="form-label">Price</label>
                <select id="priceOrder" class="form-select">
                    <option value=""> - </option> <!-- default -->
                    <option value="asc">ASC</option>
                    <option value="desc">DESC</option>
                </select>
            </div>

            <!-- Filter by room features (checkboxes - multiple selection) -->
            <div class="col-md-4">
                <label for="filterFeatures" class="form-label">Room Features</label>
                <div id="filterFeatures">
                    <label><input type="checkbox" name="feature" value="SEA_VIEW"> Sea View</label>
                    <label><input type="checkbox" name="feature" value="BALCONY"> Balcony</label>
                    <label><input type="checkbox" name="feature" value="AIR_CONDITIONING"> Air Conditioning</label>
                    <label><input type="checkbox" name="feature" value="WIFI">Wi-Fi</label>
                    <label><input type="checkbox" name="feature" value="MINIBAR">Minibar</label>
                    <label><input type="checkbox" name="feature" value="COFFEE_MAKER"> Coffee maker</label>
                    <label><input type="checkbox" name="feature" value="SAFE"> Safe</label>
                    <label><input type="checkbox" name="feature" value="QUEEN_SIZE_BED"> Queen Size Bed</label>
                    <label><input type="checkbox" name="feature" value="SINGLE_BED"> Single Bed</label>
                    <label><input type="checkbox" name="feature" value="DOUBLE_BED"> Double Bed</label>
                    <label><input type="checkbox" name="feature" value="BATHTUB"> Bathtub</label>
                    <label><input type="checkbox" name="feature" value="HOT_TUB"> Hot Tub</label>
                    <label><input type="checkbox" name="feature" value="HAIR_DRYER"> Hair Dryer</label>
                    <label><input type="checkbox" name="feature" value="ROOM_SERVICE"> Room Service</label>
                    <label><input type="checkbox" name="feature" value="DESK"> Desk</label>
                    <label><input type="checkbox" name="feature" value="HEATING"> Heating</label>
                    <label><input type="checkbox" name="feature" value="SOUNDPROOFING"> Soundproofing</label>
                    <label><input type="checkbox" name="feature" value="PET_FRIENDLY"> Pet Friendly</label>
                    <label><input type="checkbox" name="feature" value="NON_SMOKING"> Non-Smoking</label>
                    <label><input type="checkbox" name="feature" value="FREE_PARKING"> Free Parking</label>
                    <label><input type="checkbox" name="feature" value="KITCHENETTE"> Kitchenette</label>
                    <label><input type="checkbox" name="feature" value="PRIVATE_ELEVATOR"> Private Elevator</label>
                    <label><input type="checkbox" name="feature" value="SOFA"> Sofa</label>
                    <label><input type="checkbox" name="feature" value="BATHROBE_AND_SLIPPERS"> Bathrobe and Slippers</label>
                </div>
            </div>

            <!-- Filter by Availability -->
            <div class="col-md-4 row-md-1 d-flex flex-column align-items-center">
                <label for="roomAvailabilityFilter" class="form-label align-self-start">Available</label>
                <select id="roomAvailabilityFilter" class="form-select mb-4">
                    <option value="yes">YES</option> <!-- default -->
                    <option value="no">NO</option>
                </select>

            <!-- Reset filters + filter buttons -->
                <!-- <button class="btn btn-outline-success" onclick="filterRooms()">Filter</button> -->
                <button class="btn btn-outline-secondary" onclick="resetFilters()">Reset Filters</button>
            </div>
        </div>
    </div>

    <!-- Room Table -->
    <div class="card">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            Rooms
            <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#roomModal" onclick="showAddRoomForm()">Add Room</button>
        </div>
        <div class="card-body">
            <table class="table table-bordered table-striped" id="roomsTable">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>Price/Night</th>
                    <th>Available</th>
                    <th>Features</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="roomsTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Add/edit form modal -->
    <div class="modal fade" id="roomModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="formTitle">Add new room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="resetForm()"></button>
                </div>
                <div class="modal-body">
                    <form id="roomForm" onsubmit="saveRoom(event)">
                        <input type="hidden" id="roomId">
                        <div class="mb-2">
                            <label>Type:</label>
                            <select class="form-select" id="roomType">
                                <option value="SINGLE">Single</option>
                                <option value="DOUBLE">Double</option>
                                <option value="JUNIOR_SUITE">Junior Suite</option>
                                <option value="MEDIUM_SUITE">Medium Suite</option>
                                <option value="LARGE_SUITE">Large Suite</option>
                                <option value="PRESIDENTIAL_SUITE">Presidential Suite</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label>Price per Night:</label>
                            <input type="number" id="roomPrice" class="form-control" min="0">
                        </div>
                        <div class="mb-2">
                            <label>Available:</label>
                            <select id="roomAvailable" class="form-select">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label>Features (comma-separated):</label>
                            <input type="text" id="roomFeatures" class="form-control"
                                   placeholder="e.g. SEA_VIEW, BALCONY">
                        </div>
                        <div class="mb-2">
                            <label>Description:</label>
                            <textarea id="roomDescription" class="form-control"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success">Save room</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="resetForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL = "/api/rooms";
    let roomModal;

    document.addEventListener('DOMContentLoaded', () => {
        roomModal = new bootstrap.Modal(document.getElementById("roomModal"));
        loadRooms();
    });

    // load all rooms
    async function loadRooms(endpoint = API_URL) {
        const response = await fetch(endpoint);
        const rooms = await response.json();
        displayRooms(rooms);
    }

    function displayRooms(rooms) {
        const tbody = document.getElementById("roomsTableBody");
        tbody.innerHTML = "";
        rooms.forEach(room => {
            // mapping room features
            const features = Array.isArray(room.roomFeatures) ? room.roomFeatures.map(f => {return f.name;}).join(", "):'';

            tbody.insertAdjacentHTML('beforeend', `
             <tr>
                <td>${room.id}</td>
                <td>${room.roomType}</td>
                <td>${room.pricePerNight ?? ''}</td>
                <td>${room.available ? "Yes" : "No"}</td>
                <td>${features}</td>
                <td>${room.description ?? ''}</td>
                <td>
                 <button class="btn btn-sm btn-primary" onclick="editRoom(${room.id})">Edit</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteRoom(${room.id})">Delete</button>
                </td>
             </tr>
            `);
        });
    }

    function showAddRoomForm() {
        resetForm();
        document.getElementById("formTitle").textContent = "Add new room";
        roomModal.show();
    }

    async function editRoom(id) {
        const response = await fetch(`${API_URL}/${id}`);
        const room = await response.json();
        document.getElementById("roomId").value = room.id;
        document.getElementById("roomType").value = room.roomType;
        document.getElementById("roomPrice").value = room.pricePerNight;
        document.getElementById("roomAvailable").value = room.available;

        // mapping room features objects to names
        const features = Array.isArray(room.roomFeatures) ? room.roomFeatures.map(f => {return f.name;}):'';
        document.getElementById("roomFeatures").value = features.join(", ");
        document.getElementById("roomDescription").value = room.description;

        document.getElementById("formTitle").textContent = "Edit room";

        roomModal.show();
    }

    async function saveRoom(event) {
        event.preventDefault();
        const id = document.getElementById("roomId").value;
        const room = {
            roomType: document.getElementById("roomType").value,
            pricePerNight: parseFloat(document.getElementById("roomPrice").value),
            available: document.getElementById("roomAvailable").value === "true",
            roomFeatures: document.getElementById("roomFeatures").value.split(",").map(f => f.trim()).filter(f => f).map(f => ({name: f})),
            description: document.getElementById("roomDescription").value
        };

        const method = id ? "PUT" : "POST";
        const url = id ? `${API_URL}/${id}` : API_URL;

        try {
            const response = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(room)
            });

            const text = await response.text();
            console.log('STATUS', response.status, 'BODY:', text)

            if (response.ok) {
                await loadRooms();
                roomModal.hide();
                resetForm();
            } else {
                alert(`Error saving room. ${response.status}\n${text}`);
            }

        } catch (e) {
            console.error("FETCH ERROR", e);
            alert(e.message);
        }

    }

    async function deleteRoom(id) {
        if (!confirm("Are you sure you want to delete this room?")) return;
        await fetch(`${API_URL}/${id}`, {method: "DELETE"});
        await loadRooms();
    }

    function resetForm() {
        document.getElementById("roomForm").reset();
        document.getElementById("roomId").value = "";
        document.getElementById("formTitle").textContent = "Add new room";
    }

    // Filters
    function filterRooms() {
        // room type
        const type = document.getElementById("roomTypeFilter").value;

        // checkboxes (features)
        const checkboxes = document.getElementsByName("feature");
        const selectedFeatures = [];

        for (let i=0; i < checkboxes.length; i++) {
            if(checkboxes[i].checked) {
                selectedFeatures.push(checkboxes[i].value);
            }
        }

        let availability = document.getElementById("roomAvailabilityFilter").value;
        if (availability.toLowerCase() === "yes") { availability = true; }
        else { availability = false; }

        const priceOrder = document.getElementById("priceOrder").value;

        // build query
        let query = "";
        if (type) query += `type=${type}`;
        if (selectedFeatures.length) {
            if (query) query += "&";
            query += `features=${selectedFeatures.join(",")}`;
        }
        if (availability !== null) {
            if (query) query += "&";
            query += `availability=${availability}`;
        }
        if (query) query += "&";
        query += `priceOrder=${priceOrder}`

        // load results
        const endpoint = query ? `${API_URL}/filter?${query}` : API_URL;
        loadRooms(endpoint);
    }

    document.getElementById("roomTypeFilter").addEventListener("change", filterRooms);
    document.getElementById("filterFeatures").addEventListener("change", filterRooms);
    document.getElementById("roomAvailabilityFilter").addEventListener('change', filterRooms);
    document.getElementById("priceOrder").addEventListener('change', filterRooms);

    // viewing all existing rooms + back to default values:
    // roomType: "All", roomFeatures: none selected, available: "Yes", price: "asc"
    function resetFilters() {
        document.getElementById("roomTypeFilter").value=""; // "All types"
        document.getElementById("priceOrder").value=""; // no specific order
        document.getElementById("roomAvailabilityFilter").value="yes";
        document.querySelectorAll("input[type='checkbox']:checked").forEach((element) => { element.click(); }); // uncheck all checked checkboxes
        loadRooms();
    }
</script>
</body>
</html>